# transformers_implementation.py
from transformers import (
        AutoTokenizer,
            AutoModelForSequenceClassification,
                AutoModelForQuestionAnswering,
                    AutoModelForCausalLM,
                        TrainingArguments,
                            Trainer,
                                pipeline,
                                    BertConfig,
                                        BertForSequenceClassification
)
from datasets import load_dataset
import torch
import numpy as np
from sklearn.metrics import accuracy_score

def text_classification_example():
    """Text classification using DistilBERT on IMDB dataset"""
        print("\n=== Running Text Classification Example ===")
            
                # Load and prepare dataset
                    dataset = load_dataset("imdb")
                        train_dataset = dataset["train"].shuffle().select(range(1000))
                            eval_dataset = dataset["test"].shuffle().select(range(200))
                                
                                    tokenizer = AutoTokenizer.from_pretrained("distilbert-base-uncased")
                                        
                                            def tokenize_function(examples):
                                                    return tokenizer(examples["text"], padding="max_length", truncation=True)
                                                        
                                                            tokenized_train = train_dataset.map(tokenize_function, batched=True)
                                                                tokenized_eval = eval_dataset.map(tokenize_function, batched=True)
                                                                    
                                                                        # Load model
                                                                            model = AutoModelForSequenceClassification.from_pretrained("distilbert-base-uncased", num_labels=2)
                                                                                
                                                                                    # Training setup
                                                                                        training_args = TrainingArguments(
                                                                                                    output_dir="./results",
                                                                                                            evaluation_strategy="epoch",
                                                                                                                    learning_rate=2e-5,
                                                                                                                            per_device_train_batch_size=16,
                                                                                                                                    per_device_eval_batch_size=16,
                                                                                                                                            num_train_epochs=1,  # Reduced for demo purposes
                                                                                                                                                    weight_decay=0.01,
                                                                                        )
                                                                                            
                                                                                                def compute_metrics(eval_pred):
                                                                                                        logits, labels = eval_pred
                                                                                                                predictions = np.argmax(logits, axis=-1)
                                                                                                                        return {"accuracy": accuracy_score(labels, predictions)}
                                                                                                                            
                                                                                                                                trainer = Trainer(
                                                                                                                                            model=model,
                                                                                                                                                    args=training_args,
                                                                                                                                                            train_dataset=tokenized_train,
                                                                                                                                                                    eval_dataset=tokenized_eval,
                                                                                                                                                                            compute_metrics=compute_metrics,
                                                                                                                                )
                                                                                                                                    
                                                                                                                                        # Train and evaluate
                                                                                                                                            trainer.train()
                                                                                                                                                eval_results = trainer.evaluate()
                                                                                                                                                    print(f"\nEvaluation results: {eval_results}")

                                                                                                                                                    def question_answering_example():
                                                                                                                                                        """Question answering on SQuAD dataset"""
                                                                                                                                                            print("\n=== Running Question Answering Example ===")
                                                                                                                                                                
                                                                                                                                                                    # Load and prepare dataset
                                                                                                                                                                        qa_dataset = load_dataset("squad").shuffle().select(range(300))  # Smaller subset for demo
                                                                                                                                                                            
                                                                                                                                                                                model = AutoModelForQuestionAnswering.from_pretrained("distilbert-base-uncased")
                                                                                                                                                                                    tokenizer = AutoTokenizer.from_pretrained("distilbert-base-uncased")
                                                                                                                                                                                        
                                                                                                                                                                                            def prepare_qa_features(examples):
                                                                                                                                                                                                    tokenized_examples = tokenizer(
                                                                                                                                                                                                                    examples["question"],
                                                                                                                                                                                                                                examples["context"],
                                                                                                                                                                                                                                            truncation="only_second",
                                                                                                                                                                                                                                                        max_length=384,
                                                                                                                                                                                                                                                                    stride=128,
                                                                                                                                                                                                                                                                                return_overflowing_tokens=True,
                                                                                                                                                                                                                                                                                            return_offsets_mapping=True,
                                                                                                                                                                                                                                                                                                        padding="max_length",
                                                                                                                                                                                                    )
                                                                                                                                                                                                            
                                                                                                                                                                                                                    offset_mapping = tokenized_examples.pop("offset_mapping")
                                                                                                                                                                                                                            tokenized_examples["start_positions"] = []
                                                                                                                                                                                                                                    tokenized_examples["end_positions"] = []
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                    for i, offsets in enumerate(offset_mapping):
                                                                                                                                                                                                                                                                answers = examples["answers"][i]
                                                                                                                                                                                                                                                                            if len(answers["answer_start"]) == 0:
                                                                                                                                                                                                                                                                                            tokenized_examples["start_positions"].append(0)
                                                                                                                                                                                                                                                                                                            tokenized_examples["end_positions"].append(0)
                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                        start_char = answers["answer_start"][0]
                                                                                                                                                                                                                                                                                                                                                                    end_char = start_char + len(answers["text"][0])
                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                            tokenized_examples["start_positions"].append(0)
                                                                                                                                                                                                                                                                                                                                                                                                        tokenized_examples["end_positions"].append(0)
                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                for token_pos, (char_start, char_end) in enumerate(offsets):
                                                                                                                                                                                                                                                                                                                                                                                                                                                if char_start <= start_char < char_end:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tokenized_examples["start_positions"][-1] = token_pos
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if char_start < end_char <= char_end:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tokenized_examples["end_positions"][-1] = token_pos
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return tokenized_examples
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tokenized_qa = qa_dataset.map(prepare_qa_features, batched=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Train
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            trainer = Trainer(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model=model,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                args=TrainingArguments(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                output_dir="./qa_results",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            per_device_train_batch_size=8,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        num_train_epochs=1,  # Reduced for demo
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    learning_rate=3e-5,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        train_dataset=tokenized_qa,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    trainer.train()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("\nQuestion answering model trained.")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def text_generation_example():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Text generation using GPT-2"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("\n=== Running Text Generation Example ===")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        generator = pipeline("text-generation", model="gpt2")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                generated_text = generator(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "In a world where artificial intelligence",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    max_length=50,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            num_return_sequences=1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    temperature=0.7,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("\nGenerated text:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(generated_text[0]["generated_text"])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def pretrained_models_example():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """Examples using various pretrained models"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("\n=== Running Pretrained Models Examples ===")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Zero-shot classification
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                classifier = pipeline("zero-shot-classification", model="facebook/bart-large-mnli")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    result = classifier(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "This is a tutorial about transformer models",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        candidate_labels=["education", "technology", "politics"],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"\nZero-shot classification result: {result['labels'][0]} (confidence: {result['scores'][0]:.2f})")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Named Entity Recognition
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ner_pipeline = pipeline("ner", model="dbmdz/bert-large-cased-finetuned-conll03-english")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ner_results = ner_pipeline("Google was founded in Mountain View, California")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("\nNamed Entities:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for entity in ner_results:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"{entity['word']} -> {entity['entity']} (confidence: {entity['score']:.2f})")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def custom_model_example():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Creating and training a custom BERT model"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("\n=== Running Custom Model Example ===")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        config = BertConfig.from_pretrained(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "bert-base-uncased",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            num_labels=3,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    hidden_dropout_prob=0.2,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            attention_probs_dropout_prob=0.1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                custom_model = BertForSequenceClassification(config)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("\nCustom BERT model created with configuration:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(config)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def main():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Run all examples
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                text_classification_example()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    question_answering_example()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        text_generation_example()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            pretrained_models_example()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                custom_model_example()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    main()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                    )
                                                                                                                                )
                                                                                        )
)